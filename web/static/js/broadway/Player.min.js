/*!
 * Broadway.js - A JavaScript H.264 decoder.
 * https://github.com/mbebenita/Broadway/
 * Released under the BSD-3 Clause License (https://github.com/mbebenita/Broadway/blob/master/LICENSE)
 */
!function(e,t){"function"==typeof define&&define.amd?define(["./Decoder","./YUVCanvas"],t):"object"==typeof exports?module.exports=t(require("./Decoder"),require("./YUVCanvas")):e.Player=t(e.Decoder,e.YUVCanvas)}(this,function(e,t){"use strict";var a=e.nowValue,i=function(t){var i=this;this._config=t||{},this.render=!0,!1===this._config.render&&(this.render=!1),this.nowValue=a,this._config.workerFile=this._config.workerFile||"Decoder.js",this._config.preserveDrawingBuffer&&(this._config.contextOptions=this._config.contextOptions||{},this._config.contextOptions.preserveDrawingBuffer=!0);var n="auto";if(!0===this._config.webgl?n=!0:!1===this._config.webgl&&(n=!1),"auto"==n){n=!0;try{if(window.WebGLRenderingContext)document.createElement("canvas").getContext("webgl")||(n=!1);else n=!1}catch(e){n=!1}}this.webgl=n,this.webgl?(this.createCanvasObj=this.createCanvasWebGL,this.renderFrame=this.renderFrameWebGL):(this.createCanvasObj=this.createCanvasRGB,this.renderFrame=this.renderFrameRGB);var s=function(e,t,n,s){i.onPictureDecoded(e,t,n,s);a();e&&i.render&&(i.renderFrame({canvasObj:i.canvasObj,data:e,width:t,height:n}),i.onRenderFrameComplete&&i.onRenderFrameComplete({data:e,width:t,height:n,infos:s,canvasObj:i.canvasObj}))};if(this._config.size||(this._config.size={}),this._config.size.width=this._config.size.width||200,this._config.size.height=this._config.size.height||200,this._config.useWorker){var r=new Worker(this._config.workerFile);this.worker=r,r.addEventListener("message",function(e){var t=e.data;t.consoleLog?console.log(t.consoleLog):s.call(i,new Uint8Array(t.buf,0,t.length),t.width,t.height,t.infos)},!1),r.postMessage({type:"Broadway.js - Worker init",options:{rgb:!n,memsize:this.memsize,reuseMemory:!!this._config.reuseMemory}}),this._config.transferMemory?this.decode=function(e,t){r.postMessage({buf:e.buffer,offset:e.byteOffset,length:e.length,info:t},[e.buffer])}:this.decode=function(e,t){var a=new Uint8Array(e.length);a.set(e,0,e.length),r.postMessage({buf:a.buffer,offset:0,length:e.length,info:t},[a.buffer])},this._config.reuseMemory&&(this.recycleMemory=function(e){r.postMessage({reuse:e.buffer},[e.buffer])})}else this.decoder=new e({rgb:!n}),this.decoder.onPictureDecoded=s,this.decode=function(e,t){i.decoder.decode(e,t)};this.render&&(this.canvasObj=this.createCanvasObj({contextOptions:this._config.contextOptions}),this.canvas=this.canvasObj.canvas),this.domNode=this.canvas,this._config.size.width,this._config.size.height};return i.prototype={onPictureDecoded:function(e,t,a,i){},recycleMemory:function(e){},createCanvasWebGL:function(e){var t=this._createBasicCanvasObj(e);return t.contextOptions=e.contextOptions,t},createCanvasRGB:function(e){return this._createBasicCanvasObj(e)},_createBasicCanvasObj:function(e){var t={},a=(e=e||{}).width;a||(a=this._config.size.width);var i=e.height;return i||(i=this._config.size.height),t.canvas=document.createElement("canvas"),t.canvas.width=a,t.canvas.height=i,t.canvas.style.backgroundColor="#0D0E1B",t},renderFrameWebGL:function(e){var a=e.canvasObj,i=e.width||a.canvas.width,n=e.height||a.canvas.height;a.canvas.width===i&&a.canvas.height===n&&a.webGLCanvas||(a.canvas.width=i,a.canvas.height=n,a.webGLCanvas=new t({canvas:a.canvas,contextOptions:a.contextOptions,width:i,height:n}));var s=i*n,r=i/2*(n/2);a.webGLCanvas.drawNextOutputPicture({yData:e.data.subarray(0,s),uData:e.data.subarray(s,s+r),vData:e.data.subarray(s+r,s+r+r)});this.recycleMemory(e.data)},renderFrameRGB:function(e){var t=e.canvasObj,a=e.width||t.canvas.width,i=e.height||t.canvas.height;t.canvas.width===a&&t.canvas.height===i||(t.canvas.width=a,t.canvas.height=i);var n=t.ctx,s=t.imgData;n||(t.ctx=t.canvas.getContext("2d"),n=t.ctx,t.imgData=n.createImageData(a,i),s=t.imgData),s.data.set(e.data),n.putImageData(s,0,0);this.recycleMemory(e.data)}},i});